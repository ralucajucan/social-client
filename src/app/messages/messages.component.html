<app-toolbar></app-toolbar>

<mat-sidenav-container>
  <mat-sidenav mode="side" opened>
    <form class="search-form">
      <mat-form-field class="example-full-width">
        <mat-icon matPrefix>search</mat-icon>
        <input
          type="text"
          placeholder="Cautare prieteni..."
          aria-label="Number"
          matInput
          [formControl]="textControl"
        />
      </mat-form-field>
    </form>
    {{ searchText$ | async }}

    <mat-selection-list
      *ngIf="
        (connectionStatus$ | async) === 'OPEN' && (users$ | async) !== [];
        else notFound
      "
      #contacts
      [multiple]="false"
    >
      <mat-list-option
        (click)="selectUser(user)"
        *ngFor="let user of users$ | async; last as last"
        [value]="user"
      >
        <app-avatar
          mat-list-avatar
          [name]="user.name"
          [badge]="true"
          [online]="user.online"
        ></app-avatar>
        <h4 mat-line [matTooltip]="user.name">{{ user.name }}</h4>
        <span mat-line [matTooltip]="user.email">{{ user.email }}</span>
        <mat-divider [inset]="true" *ngIf="!last"></mat-divider>
      </mat-list-option>
    </mat-selection-list>
    <ng-template #notFound>
      <ng-container *ngIf="(searchText$ | async) !== ''; else notConnected"
        >Nu sunt rezultate.</ng-container
      >
    </ng-template>
    <ng-template #notConnected
      ><mat-icon color="warn">warning</mat-icon>Nu sunteti
      conectat!</ng-template
    >
    <app-status [status]="connectionStatus$ | async"></app-status>
  </mat-sidenav>

  <mat-sidenav-content *ngIf="selectedUser.email !== ''">
    <div class="messages-contact">
      <app-avatar
        mat-list-avatar
        [name]="selectedUser.name"
        [badge]="true"
        [online]="selectedUser.online"
      ></app-avatar>
      <h2>{{ selectedUser.name }}</h2>
    </div>

    <div class="messages-list">
      <mat-list>
        <mat-list-item>
          <button
            mat-button
            (click)="loadMore()"
            *ngIf="!endOfConversation; else endConv"
          >
            Mai vechi...
          </button>
          <ng-template #endConv>Sfârșitul conversației</ng-template>
        </mat-list-item>
        <mat-list-item *ngFor="let message of receivedMessages; let i = index">
          <app-avatar
            [name]="message.sender | emailBase: (users$ | async)"
          ></app-avatar>
          <div>
            <mat-card class="mat-elevation-z0"
              ><button
                class="file-button"
                mat-raised-button
                type="button"
                *ngIf="message.attachments"
                (click)="
                  download(
                    message.attachmentIds,
                    message.attachments[0].name,
                    i
                  )
                "
              >
                {{ message.attachments[0].name }}
              </button>
              {{ message.text }}
            </mat-card>
            <mat-progress-bar
              *ngIf="
                i === selectedToDownload && (download$ | async) as download
              "
              [mode]="download.state == 'PENDING' ? 'buffer' : 'determinate'"
              [value]="download.progress"
            >
            </mat-progress-bar>
          </div>
          <h6>{{ message.createdOn | date: "medium" }}</h6>
        </mat-list-item>
      </mat-list>
    </div>

    <div class="messages-input">
      <mat-divider></mat-divider>
      <form [formGroup]="messageForm" (ngSubmit)="onSendMessage()">
        <div class="messages-input-top">
          <button
            class="file-button"
            mat-stroked-button
            type="button"
            (click)="fileInput.click()"
          >
            <mat-icon *ngIf="!file">attach_file</mat-icon
            >{{ file ? file.name : "Fișier" }}
            <mat-progress-bar
              *ngIf="upload"
              [mode]="upload.state == 'PENDING' ? 'buffer' : 'determinate'"
              [value]="upload.progress"
            >
            </mat-progress-bar>
          </button>
          <input
            hidden
            id="file"
            type="file"
            #fileInput
            (change)="onFileInput(fileInput.files)"
          />
          <button mat-icon-button color="primary">
            <mat-icon>send</mat-icon>
          </button>
        </div>
        <mat-form-field appearance="outline" class="messages-input-textarea">
          <mat-label>Trimiteti mesaj catre {{ selectedUser.name }}</mat-label>
          <textarea
            matInput
            cdkTextareaAutosize
            #autosize="cdkTextareaAutosize"
            cdkAutosizeMinRows="1"
            cdkAutosizeMaxRows="5"
            id="text"
            type="text"
            formControlName="text"
            (keyup.enter)="onSendMessage()"
          ></textarea>
          <mat-error>Continutul mesajului e gol!</mat-error>
        </mat-form-field>
      </form>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
